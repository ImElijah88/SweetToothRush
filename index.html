<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweet Tooth Rush</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            background-color: #0A0A0A;
            color: #00FF00;
            font-family: 'Press Start 2P', cursive;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            position: relative;
            margin: 0;
            overflow: hidden;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        canvas {
            border: 2px solid #00FF00;
            background: #0A0A0A;
            margin-top: 20px;
        }

        .game-info {
            margin-top: 10px;
            font-size: 1rem;
        }

        .btn {
            background-color: #DB2777;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            font-family: 'Press Start 2P', cursive;
            cursor: pointer;
            border: none;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            color: #00FF00;
        }
        
        .character-image {
            width: 60px;
            height: 60px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: border-color 0.2s ease;
            border-radius: 8px;
        }

        .character-image:hover {
            border-color: #00FF00;
            box-shadow: 0 0 10px #00FF00;
        }

        #playAgainBtn, #reviveBtn, #startGameBtn, #characterSelectContainer, #difficultySelectContainer {
            display: none;
            margin: 20px auto;
        }

        #reviveBtn {
            background-color: #00FF00;
            color: black;
        }

        #reviveBtn:hover {
            color: white;
        }

        #messageBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            border: 2px solid #00FF00;
            color: #00FF00;
            font-family: 'Press Start 2P', cursive;
            z-index: 1000;
            text-align: center;
            display: none;
            border-radius: 12px;
        }

        @keyframes flash {
            0% { color: #00FF00; }
            50% { color: yellow; }
            100% { color: #00FF00; }
        }

        .flash {
            animation: flash 0.5s ease-in-out 2;
        }

        #highScoreTableContainer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.9);
            border: 2px solid #00FF00;
            color: #00FF00;
            font-family: 'Press Start 2P', cursive;
            z-index: 1000;
            text-align: center;
            display: none;
            width: 80%;
            max-width: 400px;
            max-height: 500px;
            overflow-y: auto;
            border-radius: 12px;
        }
        
        #highScoreTableContainer h3 {
            color: #FF00A0;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        #highScoreTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        #highScoreTable th, #highScoreTable td {
            padding: 8px;
            border-bottom: 1px solid #00FF00;
            text-align: left;
        }

        #nameInputContainer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.9);
            border: 2px solid #00FF00;
            color: #00FF00;
            font-family: 'Press Start 2P', cursive;
            z-index: 1000;
            text-align: center;
            display: none;
            width: 80%;
            max-width: 400px;
            border-radius: 12px;
        }

        #nameInputContainer input {
            background-color: rgba(0, 0, 0, 0.8);
            border: 1px solid #00FF00;
            padding: 8px;
            color: white;
            text-align: center;
            border-radius: 8px;
        }
        
        #pauseBtn, #infoBtn {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        #pauseBtn {
            top: 30px;
            left: 30px;
            background-color: #DB2777;
            color: white;
        }

        #pauseBtn:hover {
            background-color: #FF00A0;
            box-shadow: 0 0 15px #FF00A0;
        }

        #infoBtn {
            top: 30px;
            right: 30px;
            background-color: #00FF00;
            color: black;
            font-family: serif;
            font-style: italic;
            font-weight: bold;
        }

        #infoBtn:hover {
            background-color: #00FF00;
            box-shadow: 0 0 20px #00FF00;
        }

        #pauseMenu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.9);
            border: 2px solid #00FF00;
            color: #00FF00;
            font-family: 'Press Start 2P', cursive;
            z-index: 1002;
            text-align: center;
            display: none;
            width: 80%;
            max-width: 400px;
            border-radius: 12px;
        }

        #infoBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.9);
            border: 2px solid #00FF00;
            color: #00FF00;
            font-family: 'Press Start 2P', cursive;
            z-index: 1000;
            text-align: left;
            display: none;
            width: 80%;
            max-width: 400px;
            max-height: 500px;
            overflow-y: auto;
            border-radius: 12px;
        }

        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .info-table th, .info-table td {
            padding: 8px;
            border-bottom: 1px solid #00FF00;
            text-align: left;
        }

        .game-header {
            position: relative;
            width: 100%;
            padding-top: 10px;
        }

        .game-title {
            font-size: 1.5rem;
        }

        .game-subtitle {
            font-size: 0.75rem;
        }

        #splashScreen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            height: 400px;
            background-color: #0A0A0A;
            border: 2px solid #00FF00;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            cursor: pointer;
            z-index: 1003;
        }

        .splash-text {
            color: #DB2777;
            font-size: 2rem;
            animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

    </style>
</head>
<body>

    <div id="splashScreen">
        <h1 class="splash-text">Click to Start</h1>
    </div>

    <div class="game-container">
        <div class="game-header">
            <h2 class="game-title" style="color: #00FF00;">Sweet Tooth Rush</h2>
            <p class="game-subtitle">Move your mouse to catch the treats!</p>
        </div>
        <canvas id="gameCanvas" width="600" height="400"></canvas>
        <div class="game-info">
            Score: <span id="score">0</span> | High Score: <span id="high-score">0</span> | Missed: <span id="missed">0</span> 
            <span id="reviveIndicator" style="display:none;">➕</span>
        </div>
        
        <button id="infoBtn" style="display:none;">i</button>
        <button id="pauseBtn" style="display:none;">||</button>

        <div id="mainMenuScreen" style="display:none;">
            <h2 class="text-3xl" style="color: #FF00A0;">Sweet Tooth Rush</h2>
            <div id="genderSelectContainer" class="mt-4">
                <p>Choose your gender:</p>
                <div class="flex justify-center space-x-4 mt-2">
                    <button id="boyBtn" class="btn">Boy</button>
                    <button id="girlBtn" class="btn">Girl</button>
                </div>
            </div>

            <div id="characterSelectContainer" style="display:none;" class="mt-4">
                <p>Select your character:</p>
                <div id="characterOptions" class="flex justify-center space-x-4 mt-2">
                </div>
            </div>

            <div id="difficultySelectContainer" class="mt-4">
                <p>Choose your difficulty:</p>
                <div class="flex justify-center space-x-4 mt-2">
                    <button id="noobBtn" class="btn">Noob</button>
                    <button id="playerBtn" class="btn">Player</button>
                    <button id="proBtn" class="btn">Pro</button>
                </div>
            </div>

            <button id="startGameBtn" class="btn" style="display:none;">Start Game</button>
            <button id="showScoresBtn" class="btn">Show High Scores</button>
        </div>

        <button id="playAgainBtn" class="btn">Play Again</button>
        <button id="reviveBtn" class="btn">Revive?</button>
        
        <div id="nameInputContainer">
            <p>You made it to the leaderboard! Enter your name:</p>
            <input type="text" id="playerNameInput" maxlength="10" placeholder="Player Name" class="bg-gray-800 text-white p-2 rounded mt-2">
            <button id="saveScoreBtn" class="btn">Save Score</button>
        </div>

        <div id="highScoreTableContainer" style="display:none;">
            <h3 class="text-2xl">High Scores</h3>
            <table id="highScoreTable">
                <thead>
                    <tr><th>Rank</th><th>Name</th><th>Score</th></tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <button id="closeTableBtn" class="btn">Close</button>
        </div>

        <div id="messageBox">
            <span id="messageText"></span>
            <br>
            <button id="closeMessageBtn" class="btn">OK</button>
        </div>

        <div id="infoBox">
            <h3 class="text-2xl" style="color: #FF00A0;">Game Information</h3>
            <div id="infoContent"></div>
            <button id="closeInfoBtn" class="btn mt-4">Close</button>
        </div>

        <div id="pauseMenu">
            <h3 class="text-2xl" style="color: #00FF00;">Game Paused</h3>
            <button id="resumeBtn" class="btn">Resume</button>
            <button id="returnToMenuBtn" class="btn">Return to Main Menu</button>
        </div>

    </div>

    <script>
        // --- GAME VARIABLES ---
        let score = 0;
        let missed = 0;
        let gameOver = false;
        let gameSpeed = 2;
        let highScore = 0;
        let isPaused = false;
        const items = [];
        let itemsWithWeighting = [];
        let isCompanionActive = false;
        let companionTimer = null;
        let isGrowingActive = false;
        let growTimer = null;
        let isMagnetActive = false;
        let magnetTimer = null;
        let lastLevel = 0;
        let canRevive = false;
        let reviveUsed = false;
        const HIGHSCORE_THRESHOLD = 1000;
        let playerImageSrc = '';
        let companionImageSrc = '';
        let companionDuration = 30000;
        let growDuration = 15000;
        let magnetDuration = 7000;
        let selectedDifficulty = 'noob';

        // --- IMAGE ASSETS ---
        // Replaced local paths with web URLs to work in preview
        const characterImages = {
            boy: [
                '../assets/boy1.png',
                '../assets/boy3.png',
                '../assets/boy4.png',
            ],
            girl: [
                '../assets/girl1.png',
                '../assets/girl2.png',
                '../assets/girl4.png',
            ]
        };

        const companionImages = {
            boy: '../assets/girl5.png',
            girl: '../assets/boy5.png',
        };

        // --- HIGH SCORE LOGIC (LOCALSTORAGE ONLY) ---
        function saveHighScore(newScore, playerName) {
            let highScores = JSON.parse(localStorage.getItem('sweetToothRushScores') || '[]');
            highScores.push({ name: playerName, score: newScore });
            highScores.sort((a, b) => b.score - a.score);
            highScores = highScores.slice(0, 10); // Keep only top 10
            localStorage.setItem('sweetToothRushScores', JSON.stringify(highScores));
        }

        function fetchHighScore() {
            const localHighScores = JSON.parse(localStorage.getItem('sweetToothRushScores') || '[]');
            if (localHighScores.length > 0) {
                highScore = localHighScores[0].score;
                document.getElementById('high-score').textContent = highScore;
            }
        }

        function displayHighScores() {
            const localHighScores = JSON.parse(localStorage.getItem('sweetToothRushScores') || '[]');
            const tableBody = document.querySelector('#highScoreTable tbody');
            tableBody.innerHTML = '';
            localHighScores.forEach((score, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${index + 1}</td><td>${score.name}</td><td>${score.score}</td>`;
                tableBody.appendChild(row);
            });
            document.getElementById('highScoreTableContainer').style.display = 'block';
        }

        // --- GAME INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENT REFERENCES ---
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const scoreSpan = document.getElementById('score');
            const missedSpan = document.getElementById('missed');
            const reviveIndicator = document.getElementById('reviveIndicator');
            const playAgainBtn = document.getElementById('playAgainBtn');
            const reviveBtn = document.getElementById('reviveBtn');
            const startGameBtn = document.getElementById('startGameBtn');
            const mainMenuScreen = document.getElementById('mainMenuScreen');
            const genderSelectContainer = document.getElementById('genderSelectContainer');
            const boyBtn = document.getElementById('boyBtn');
            const girlBtn = document.getElementById('girlBtn');
            const characterSelectContainer = document.getElementById('characterSelectContainer');
            const characterOptions = document.getElementById('characterOptions');
            const difficultySelectContainer = document.getElementById('difficultySelectContainer');
            const noobBtn = document.getElementById('noobBtn');
            const playerBtn = document.getElementById('playerBtn');
            const proBtn = document.getElementById('proBtn');
            const nameInputContainer = document.getElementById('nameInputContainer');
            const playerNameInput = document.getElementById('playerNameInput');
            const saveScoreBtn = document.getElementById('saveScoreBtn');
            const highScoreTableContainer = document.getElementById('highScoreTableContainer');
            const closeTableBtn = document.getElementById('closeTableBtn');
            const showScoresBtn = document.getElementById('showScoresBtn');
            const splashScreen = document.getElementById('splashScreen');
            const pauseBtn = document.getElementById('pauseBtn');
            const pauseMenu = document.getElementById('pauseMenu');
            const resumeBtn = document.getElementById('resumeBtn');
            const returnToMenuBtn = document.getElementById('returnToMenuBtn');
            const infoBtn = document.getElementById('infoBtn');
            const infoBox = document.getElementById('infoBox');
            const closeInfoBtn = document.getElementById('closeInfoBtn');
            const infoContent = document.getElementById('infoContent');

            fetchHighScore();
            
            // --- GAME OBJECTS ---
            const baker = {
                x: canvas.width / 2 - 25,
                y: canvas.height - 60,
                width: 50,
                height: 50,
                image: new Image(),
                isReady: false
            };
            
            const companion = {
                x: 0,
                y: canvas.height - 60,
                width: 50,
                height: 50,
                image: new Image(),
                isReady: false
            };
            
            const itemTypes = [
                { name: 'Fortune Cookie', emoji: '🥠', score: 100, speed: 5, type: 'sweet' },
                { name: 'Cherry Pie', emoji: '🍒', score: 50, speed: 4, type: 'sweet' },
                { name: 'Ice Cream', emoji: '🍦', score: 20, speed: 3.5, type: 'sweet' },
                { name: 'Cupcake', emoji: '🧁', score: 10, speed: 3, type: 'sweet' },
                { name: 'Donut', emoji: '🍩', score: 5, speed: 2.5, type: 'sweet' },
                { name: 'Lollipop', emoji: '🍭', score: 3, speed: 2, type: 'sweet' },
                { name: 'Cookie', emoji: '🍪', score: 1, speed: 1.5, type: 'sweet' },
                { name: 'Apple', emoji: '🍎', score: 0, speed: 2, type: 'healthy', powerUp: 'Companion' },
                { name: 'Mushroom', emoji: '🍄', score: 0, speed: 3.5, type: 'grow', powerUp: 'Growth' },
                { name: 'Watermelon', emoji: '🍉', score: 0, speed: 4, type: 'magnet', powerUp: 'Magnet' },
                { name: 'Grapes', emoji: '🍇', score: 0, speed: 3.5, type: 'revive', powerUp: 'Revive' },
            ];
            
            function updateItemSpawnPool() {
                itemsWithWeighting = [];
                const sweetItems = itemTypes.filter(t => t.type === 'sweet');
                const powerUpItems = itemTypes.filter(t => t.powerUp);
                
                const weights = { 1: 10, 3: 8, 5: 6, 10: 4, 20: 3, 50: 2, 100: 1 };
                
                for (const item of sweetItems) {
                    itemsWithWeighting.push(...Array(weights[item.score]).fill(item));
                }
                itemsWithWeighting.push(...powerUpItems);
            }
            
            // --- DRAWING FUNCTIONS ---
            function drawBaker() {
                let bakerWidth = isGrowingActive ? baker.width * 2 : baker.width;
                let bakerHeight = isGrowingActive ? baker.height * 2 : baker.height;

                if (baker.isReady) {
                    ctx.drawImage(baker.image, baker.x, baker.y, bakerWidth, bakerHeight);
                }
                
                if (isCompanionActive && companion.isReady) {
                    companion.x = baker.x - companion.width - 10;
                    ctx.drawImage(companion.image, companion.x, companion.y, companion.width, companion.height);
                }
            }

            function drawItems() {
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                for (let item of items) {
                    ctx.fillText(item.emoji, item.x, item.y);
                }
            }
            
            // --- CORE GAME LOOP ---
            function updateGame() {
                if (gameOver || isPaused) return;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Award extra lives at score milestones
                const scoreThresholds = [1000, 2000, 3000, 5000, 10000];
                const currentLevelThreshold = scoreThresholds.find(t => score >= t && lastLevel < t);
                if (currentLevelThreshold) {
                    if (missed > 0) {
                        missed = Math.max(0, missed - 1);
                        missedSpan.textContent = missed;
                        missedSpan.classList.add('flash');
                        setTimeout(() => missedSpan.classList.remove('flash'), 1000);
                    }
                    lastLevel = currentLevelThreshold;
                }

                // Increase game speed with score
                let newGameSpeed = 2;
                if (score >= 10000) newGameSpeed = 8;
                else if (score >= 5000) newGameSpeed = 7;
                else if (score >= 3000) newGameSpeed = 6;
                else if (score >= 2000) newGameSpeed = 5;
                else if (score >= 1000) newGameSpeed = 4;
                gameSpeed = newGameSpeed;
                
                // Update items
                for (let i = items.length - 1; i >= 0; i--) {
                    let item = items[i];

                    // Magnet effect
                    if (isMagnetActive) {
                        const targetX = baker.x + (isGrowingActive ? baker.width : baker.width / 2);
                        if (item.x > targetX) item.x -= 5;
                        else if (item.x < targetX) item.x += 5;
                    }

                    item.y += item.speed * (gameSpeed / 2.5); // Adjust speed based on gameSpeed

                    // Collision detection
                    let bakerWidth = isGrowingActive ? baker.width * 2 : baker.width;
                    const bakerCollision = (item.y + 10 >= baker.y && item.x > baker.x && item.x < baker.x + bakerWidth);
                    const companionCollision = (isCompanionActive && item.y + 10 >= companion.y && item.x > companion.x && item.x < companion.x + companion.width);

                    if (bakerCollision || companionCollision) {
                        if (item.type === 'healthy' && !isCompanionActive) activateCompanionPowerUp();
                        else if (item.type === 'grow' && !isGrowingActive) activateGrowPowerUp();
                        else if (item.type === 'magnet' && !isMagnetActive) activateMagnetPowerUp();
                        else if (item.type === 'revive' && !reviveUsed) {
                            canRevive = true;
                            reviveIndicator.style.display = 'inline';
                        } else if (item.type === 'sweet') {
                            score += item.score;
                            scoreSpan.textContent = score;
                        }
                        items.splice(i, 1);
                    } else if (item.y > canvas.height) { // Missed item
                        if (item.type === 'sweet') {
                            missed++;
                            missedSpan.textContent = missed;
                            if (missed >= 5) {
                                gameOver = true;
                                if (canRevive) {
                                    reviveBtn.style.display = 'block';
                                    document.removeEventListener('mousemove', moveBaker);
                                } else {
                                    showGameOverScreen();
                                }
                            }
                        }
                        items.splice(i, 1);
                    }
                }
                
                drawBaker();
                drawItems();

                // Spawn new item
                if (Math.random() < 0.03) {
                    const type = itemsWithWeighting[Math.floor(Math.random() * itemsWithWeighting.length)];
                    items.push({
                        x: Math.random() * (canvas.width - 20) + 10,
                        y: 0,
                        speed: type.speed,
                        emoji: type.emoji,
                        score: type.score,
                        type: type.type
                    });
                }

                requestAnimationFrame(updateGame);
            }
            
            // --- POWER-UP FUNCTIONS ---
            function activateCompanionPowerUp() {
                isCompanionActive = true;
                clearTimeout(companionTimer);
                companionTimer = setTimeout(() => isCompanionActive = false, companionDuration);
            }

            function activateGrowPowerUp() {
                isGrowingActive = true;
                clearTimeout(growTimer);
                growTimer = setTimeout(() => isGrowingActive = false, growDuration);
            }
            
            function activateMagnetPowerUp() {
                isMagnetActive = true;
                clearTimeout(magnetTimer);
                magnetTimer = setTimeout(() => isMagnetActive = false, magnetDuration);
            }
            
            // --- MOUSE MOVEMENT ---
            function moveBaker(e) {
                const rect = canvas.getBoundingClientRect();
                baker.x = e.clientX - rect.left - (isGrowingActive ? baker.width : baker.width / 2);
            }
            
            // --- UI & SCREEN MANAGEMENT ---
            function showMainMenu() {
                mainMenuScreen.style.display = 'block';
                canvas.style.display = 'none';
                genderSelectContainer.style.display = 'block';
                characterSelectContainer.style.display = 'none';
                difficultySelectContainer.style.display = 'none';
                startGameBtn.style.display = 'none';
                infoBtn.style.display = 'none';
                pauseBtn.style.display = 'none';
                pauseMenu.style.display = 'none';
                nameInputContainer.style.display = 'none';
                highScoreTableContainer.style.display = 'none';
                playAgainBtn.style.display = 'none';
                reviveBtn.style.display = 'none';
                document.removeEventListener('mousemove', moveBaker);
            }

            function showCharacterSelectScreen(gender) {
                genderSelectContainer.style.display = 'none';
                characterSelectContainer.style.display = 'block';
                characterOptions.innerHTML = '';
                characterImages[gender].forEach(src => {
                    const img = document.createElement('img');
                    img.src = src;
                    img.className = 'character-image';
                    img.addEventListener('click', () => {
                        playerImageSrc = src;
                        companionImageSrc = companionImages[gender];
                        characterSelectContainer.style.display = 'none';
                        difficultySelectContainer.style.display = 'block';
                    });
                    characterOptions.appendChild(img);
                });
            }

            function setPowerUpDurations(difficulty) {
                selectedDifficulty = difficulty;
                switch (difficulty) {
                    case 'noob':
                        companionDuration = 30000; growDuration = 15000; magnetDuration = 7000;
                        break;
                    case 'player':
                        companionDuration = 20000; growDuration = 10000; magnetDuration = 4000;
                        break;
                    case 'pro':
                        companionDuration = 10000; growDuration = 5000; magnetDuration = 2000;
                        break;
                }
                difficultySelectContainer.style.display = 'none';
                startGameBtn.style.display = 'block';
            }
            
            function showGameOverScreen() {
                canvas.style.display = 'none';
                pauseBtn.style.display = 'none';
                infoBtn.style.display = 'none';
                if (score >= HIGHSCORE_THRESHOLD) {
                    nameInputContainer.style.display = 'block';
                    playerNameInput.value = '';
                } else {
                    playAgainBtn.style.display = 'block';
                }
                document.removeEventListener('mousemove', moveBaker);
                fetchHighScore();
            }
            
            function resetGameVariables() {
                score = 0; missed = 0; gameOver = false; isPaused = false;
                isCompanionActive = false; isGrowingActive = false; isMagnetActive = false;
                canRevive = false; reviveUsed = false; lastLevel = 0;
                items.length = 0;
                clearTimeout(companionTimer); clearTimeout(growTimer); clearTimeout(magnetTimer);
                scoreSpan.textContent = score;
                missedSpan.textContent = missed;
                reviveIndicator.style.display = 'none';
            }
            
            function startGame() {
                resetGameVariables();
                mainMenuScreen.style.display = 'none';
                canvas.style.display = 'block';
                infoBtn.style.display = 'block';
                pauseBtn.style.display = 'block';
                document.addEventListener('mousemove', moveBaker);
                updateItemSpawnPool();
                
                baker.isReady = false;
                companion.isReady = false;

                if (playerImageSrc) {
                    baker.image.src = playerImageSrc;
                    baker.image.onload = () => { baker.isReady = true; };
                    companion.image.src = companionImageSrc;
                    companion.image.onload = () => { companion.isReady = true; };
                }
                startCountdown();
            }

            function togglePause() {
                isPaused = !isPaused;
                if (isPaused) {
                    pauseMenu.style.display = 'block';
                    infoBox.style.display = 'none';
                    document.removeEventListener('mousemove', moveBaker);
                } else {
                    pauseMenu.style.display = 'none';
                    document.addEventListener('mousemove', moveBaker);
                    requestAnimationFrame(updateGame);
                }
            }

            function showInfo() {
                if (isPaused) return; 
                infoBox.style.display = 'block';
                const durations = {
                    noob: { companion: 30, growth: 15, magnet: 7 },
                    player: { companion: 20, growth: 10, magnet: 4 },
                    pro: { companion: 10, growth: 5, magnet: 2 }
                };

                infoContent.innerHTML = `
                    <h4 class="text-xl" style="color: #00FF00;">${selectedDifficulty.toUpperCase()} Difficulty</h4>
                    <table class="info-table">
                        <thead><tr><th>Item</th><th>Value</th></tr></thead>
                        <tbody>
                            ${itemTypes.filter(i => i.type === 'sweet').map(i => `<tr><td>${i.emoji} ${i.name}</td><td>${i.score} pts</td></tr>`).join('')}
                            ${itemTypes.filter(i => i.powerUp && i.type !== 'revive').map(i => `<tr><td>${i.emoji} ${i.name}</td><td>${durations[selectedDifficulty][i.powerUp.toLowerCase()]}s</td></tr>`).join('')}
                            <tr><td>🍇 Grapes</td><td>1 Revive</td></tr>
                        </tbody>
                    </table>`;
            }

            // --- EVENT LISTENERS ---
            playAgainBtn.addEventListener('click', showMainMenu);
            startGameBtn.addEventListener('click', startGame);
            boyBtn.addEventListener('click', () => showCharacterSelectScreen('boy'));
            girlBtn.addEventListener('click', () => showCharacterSelectScreen('girl'));
            noobBtn.addEventListener('click', () => setPowerUpDurations('noob'));
            playerBtn.addEventListener('click', () => setPowerUpDurations('player'));
            proBtn.addEventListener('click', () => setPowerUpDurations('pro'));
            showScoresBtn.addEventListener('click', () => {
                mainMenuScreen.style.display = 'none';
                displayHighScores();
            });
            saveScoreBtn.addEventListener('click', () => {
                const playerName = playerNameInput.value.trim() || "noob";
                saveHighScore(score, playerName);
                nameInputContainer.style.display = 'none';
                playAgainBtn.style.display = 'block';
            });
            closeTableBtn.addEventListener('click', () => {
                highScoreTableContainer.style.display = 'none';
                showMainMenu();
            });
            reviveBtn.addEventListener('click', () => {
                canRevive = false;
                reviveUsed = true;
                reviveIndicator.style.display = 'none';
                missed = 0;
                missedSpan.textContent = missed;
                reviveBtn.style.display = 'none';
                gameOver = false;
                document.addEventListener('mousemove', moveBaker);
                requestAnimationFrame(updateGame);
            });
            infoBtn.addEventListener('click', showInfo);
            closeInfoBtn.addEventListener('click', () => infoBox.style.display = 'none');
            splashScreen.addEventListener('click', () => {
                splashScreen.style.display = 'none';
                showMainMenu();
            }, { once: true });
            pauseBtn.addEventListener('click', togglePause);
            resumeBtn.addEventListener('click', togglePause);
            returnToMenuBtn.addEventListener('click', showMainMenu);
            
            // --- STARTUP LOGIC ---
            function startCountdown() {
                let count = 3;
                const countdownInterval = setInterval(() => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#FF00A0';
                    ctx.font = "bold 60px 'Press Start 2P'";
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const text = count > 0 ? count : 'GO!';
                    ctx.fillText(text, canvas.width / 2, canvas.height / 2);
                    if (count === 0) {
                        clearInterval(countdownInterval);
                        setTimeout(() => requestAnimationFrame(updateGame), 500);
                    }
                    count--;
                }, 1000);
            }
            
            canvas.style.display = 'none';
            mainMenuScreen.style.display = 'none';
            // Start on splash screen
        });
    </script>
</body>
</html>
